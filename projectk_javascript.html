<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("searchInput");
  const resultTableBody = document.getElementById("resultTableBody");
  const loadingIndicator = document.getElementById("loadingIndicator");
  const emptyMessage = document.getElementById("emptyMessage");

  let allApplications = [];
  let selectedApplication = null;

  // åˆæœŸãƒ­ãƒ¼ãƒ‰
  loadApplications();

  // ==============================
  // ğŸ”„ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†
  // ==============================
  function loadApplications() {
    showLoading(true);
    google.script.run
      .withSuccessHandler(applications => {
        allApplications = applications || [];
        renderTable(allApplications);
        showLoading(false);
      })
      .withFailureHandler(err => {
        console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
        showLoading(false);
        emptyMessage.textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        emptyMessage.style.display = "block";
      })
      .getApplications();
  }

  // ==============================
  // ğŸ” æ¤œç´¢å‡¦ç†
  // ==============================
  searchInput.addEventListener("input", e => {
    const keyword = e.target.value.trim().toLowerCase();
    const filtered = allApplications.filter(app =>
      app.name.toLowerCase().includes(keyword) ||
      app.id.toLowerCase().includes(keyword)
    );
    renderTable(filtered);
  });

  // ==============================
  // ğŸ§± ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
  // ==============================
  function renderTable(data) {
    resultTableBody.innerHTML = "";

    if (!data || data.length === 0) {
      emptyMessage.style.display = "block";
      return;
    }
    emptyMessage.style.display = "none";

    data.forEach((app, index) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${app.id}</td>
        <td>${app.name}</td>
        <td>${app.type}</td>
        <td>${app.currentStatus}</td>
        <td>${app.expiryDate}</td>
        <td>${app.status}</td>
      `;
      row.addEventListener("click", () => selectRow(index));
      resultTableBody.appendChild(row);
    });
  }

  // ==============================
  // âœ´ï¸ è¡Œé¸æŠ
  // ==============================
  function selectRow(index) {
    const rows = document.querySelectorAll("#resultTableBody tr");
    rows.forEach(r => r.classList.remove("selected"));
    rows[index].classList.add("selected");
    selectedApplication = allApplications[index];
  }

  // ==============================
  // â³ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  // ==============================
  function showLoading(show) {
    if (!loadingIndicator) return;
    loadingIndicator.style.display = show ? "block" : "none";
    document.getElementById("tableContainer").style.opacity = show ? 0.5 : 1;
  }

  // ==============================
  // âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒ‡ãƒ¢å¯¾å¿œï¼‰
  // ==============================
  window.sendEmailToUser = function() {
    const email = document.getElementById("userEmail").value.trim();

    if (!email) {
      alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    if (!selectedApplication) {
      alert("ã¾ãšä¸€è¦§ã‹ã‚‰ç”³è«‹ã‚’1ä»¶é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const subject = `ã€ãƒ‡ãƒ¢ã€‘ç”³è«‹çµæœï¼š${selectedApplication.name}`;
    const body = `
${selectedApplication.name} æ§˜

ä»¥ä¸‹ã¯åœ¨ç•™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ‡ãƒ¢ï¼‰ã®ç”³è«‹å†…å®¹ã§ã™ï¼š

ç”³è«‹ID: ${selectedApplication.id}
ç”³è«‹ç¨®åˆ¥: ${selectedApplication.type}
ç¾åœ¨ã®çŠ¶æ…‹: ${selectedApplication.status}
æœ‰åŠ¹æœŸé™: ${selectedApplication.expiryDate}

â€» ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚å®Ÿéš›ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚
`;

    alert("ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚\né€ä¿¡ãƒ†ã‚¹ãƒˆã‚’å®Œäº†ã—ã¾ã—ãŸã€‚");

    google.script.run
      .withSuccessHandler(() => {
        console.log("sendResultEmail() å‘¼ã³å‡ºã—å®Œäº†ï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼‰");
      })
      .withFailureHandler(err => {
        console.error("ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err);
      })
      .sendResultEmail(email, subject, body);
  };
});
</script>
