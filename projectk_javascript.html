4. projectk_javascript.html (ä¿®æ­£ç‰ˆ)

<script>
  let allApplications = [];
  let selectedApplication = null;
  let currentApplicationId = null; 
  
  document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("searchInput");
  const applicationTableBody = document.getElementById("applicationTableBody");
  const tableContainer = document.getElementById("tableContainer");

  // ğŸ’¡ã€è¿½åŠ ã€‘ç¾åœ¨ã®æ—¥ä»˜ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function displayCurrentDate() {
    const dateElement = document.getElementById("currentDate");
    if (dateElement) {
        const now = new Date();
        // æ—¥æœ¬èªå½¢å¼ã§ã€ŒYYYYå¹´MMæœˆDDæ—¥ (æ›œæ—¥)ã€ã¨è¡¨ç¤º
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
        const formattedDate = now.toLocaleDateString('ja-JP', options);
        dateElement.textContent = formattedDate;
    }
  }

  // ğŸ’¡ã€è¿½åŠ ã€‘æ—¥ä»˜è¡¨ç¤ºé–¢æ•°ã®å®Ÿè¡Œ
  displayCurrentDate();
  
  // åˆæœŸãƒ­ãƒ¼ãƒ‰
  loadApplications();

  // ==============================
  // ğŸ’¡ ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åã‹ã‚‰CSSã‚¯ãƒ©ã‚¹ã‚’å–å¾—
  // ==============================
  function getStatusClass(statusName) {
    switch (statusName) {
      case "æ–°è¦ç”³è«‹": return "status-new";
      case "å‡¦ç†ä¸­": return "status-progress";
      case "æ›¸é¡ç¢ºèªä¸­": return "status-document";
      case "æå‡ºå¾…ã¡": return "status-waiting";
      case "æå‡ºæ¸ˆã¿": return "status-submitted";
      case "å®Œäº†": return "status-completed";
      default: return "status-default";
    }
  }

  // ==============================
  // ğŸ”„ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†
  // ==============================
  function loadApplications() {
    showLoading(true);
    google.script.run
      .withSuccessHandler(applications => {
        allApplications = applications || [];
        renderTable(allApplications);
        showLoading(false);
      })
      .withFailureHandler(err => {
        console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
        showLoading(false);
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã«è¡¨ç¤º
        applicationTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px;color:red;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</td></tr>`;
      })
      .getApplications();
  }

  // ==============================
  // ğŸ” æ¤œç´¢å‡¦ç†
  // ==============================
  searchInput.addEventListener("input", e => {
    const keyword = e.target.value.trim().toLowerCase();
    const filtered = allApplications.filter(app =>
      app.name.toLowerCase().includes(keyword) ||
      app.id.toLowerCase().includes(keyword)
    );
    renderTable(filtered);
  });

  // ==============================
  // ğŸ§± ãƒ†ãƒ¼ãƒ–ãƒ«æç”» (8åˆ—ã«å¯¾å¿œ)
  // ==============================
  function renderTable(data) {
    applicationTableBody.innerHTML = "";

    if (!data || data.length === 0) {
      const row = document.createElement("tr");
      row.innerHTML = `<td colspan="8" style="text-align:center;padding:20px;">ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td>`;
      applicationTableBody.appendChild(row);
      return;
    }

    data.forEach((app, index) => {
      const statusClass = getStatusClass(app.status);
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${app.id}</td>
        <td>${app.name}</td>
        <td>${app.type}</td>
        <td>${app.currentStatus}</td>
        <td>${app.expiryDate}</td>
        <td>${app.submitDate}</td> <td><span class="status-badge ${statusClass}">${app.status}</span></td> <td><button onclick="openStatusModal('${app.id}')" class="action-button">çŠ¶æ…‹å¤‰æ›´</button></td> `;
      // æ³¨: æ¤œç´¢çµæœã‚’è€ƒæ…®ã—ã€è¡Œã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³IDã§é¸æŠã—ç›´ã™ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ˆã‚Šå®‰å…¨ã§ã™ãŒã€
      // æ—¢å­˜ã®æ§‹æˆã«åˆã‚ã›ã€ã‚·ãƒ³ãƒ—ãƒ«ã«allApplicationsã®indexã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
      // ãŸã ã—ã€selectRowé–¢æ•°å†…ã§selectedApplicationã‚’æ¢ã™ãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚ˆã‚Šãƒ­ãƒã‚¹ãƒˆã«ã™ã‚‹ãŸã‚IDã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
      row.addEventListener("click", () => selectRow(app.id));
      applicationTableBody.appendChild(row);
    });
  }

  // ==============================
  // âœ´ï¸ è¡Œé¸æŠ (IDãƒ™ãƒ¼ã‚¹ã«ä¿®æ­£)
  // ==============================
  function selectRow(applicationId) {
    const rows = document.querySelectorAll("#applicationTableBody tr");
    rows.forEach(r => r.classList.remove("selected-row"));
    
    // é¸æŠã•ã‚ŒãŸè¡Œã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®š
    let targetRow = null;
    rows.forEach(r => {
        if (r.children[0].textContent === applicationId) {
            targetRow = r;
        }
    });

    if (targetRow) {
      targetRow.classList.add("selected-row");
      // allApplicationsã‹ã‚‰æ­£ç¢ºãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™
      selectedApplication = allApplications.find(app => app.id === applicationId);
    }
  }

  // ==============================
  // â³ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  // ==============================
  function showLoading(show) {
    if (!tableContainer) return; // tableContainer IDãŒãªã„å ´åˆ
    tableContainer.style.opacity = show ? 0.5 : 1;
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºè‡ªä½“ã¯innerHTMLã§åˆ¶å¾¡ã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯é€éåº¦ã®ã¿
  }

  // ==============================
  // âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒ‡ãƒ¢å¯¾å¿œï¼‰
  // ==============================
  // projectk_javascript.html å†…ã® sendEmailToUser é–¢æ•°
  window.sendEmailToUser = function() {
      const email = document.getElementById("userEmail").value.trim();
      if (!email) {
        alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (!selectedApplication) {
        alert("ã¾ãšä¸€è¦§ã‹ã‚‰ç”³è«‹ã‚’1ä»¶é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const subject = `ã€ãƒ‡ãƒ¢ã€‘ç”³è«‹çµæœï¼š${selectedApplication.name}`;
      const body = `
  ${selectedApplication.name} æ§˜

  ä»¥ä¸‹ã¯åœ¨ç•™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ‡ãƒ¢ï¼‰ã®ç”³è«‹å†…å®¹ã§ã™ï¼š

  ç”³è«‹ID: ${selectedApplication.id}
  ç”³è«‹ç¨®åˆ¥: ${selectedApplication.type}
  ç¾åœ¨ã®çŠ¶æ…‹: ${selectedApplication.status}
  æœ‰åŠ¹æœŸé™: ${selectedApplication.expiryDate}

  â€» ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚å®Ÿéš›ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚
  `;

      // ğŸ’¡ã€ä¿®æ­£ã€‘ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã¨ãƒ‡ãƒ¢å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çµ±åˆã—ã¦è¡¨ç¤º
      alert(`ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚\né€ä¿¡ãƒ†ã‚¹ãƒˆã‚’å®Œäº†ã—ã¾ã—ãŸã€‚\n\n--- ç”Ÿæˆã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ï¼ˆç¢ºèªç”¨ï¼‰---\n${body}`);

      google.script.run
        .withSuccessHandler(() => {
          console.log("sendResultEmail() å‘¼ã³å‡ºã—å®Œäº†ï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼‰");
        })
        .withFailureHandler(err => {
          console.error("ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err);
        })
        .sendResultEmail(email, subject, body);
    };
  
  // ==============================
  // âš™ï¸ çŠ¶æ…‹æ›´æ–°ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
  // ==============================
  window.openStatusModal = function(applicationId) {
    currentApplicationId = applicationId;
    const modal = document.getElementById("statusModal");
    const app = allApplications.find(a => a.id === applicationId);

    document.getElementById("modalId").textContent = applicationId;
    
    // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¨­å®š (UXæ”¹å–„)
    if (app && app.status) {
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åã‹ã‚‰ã‚­ãƒ¼ã‚’æ¢ã™ (config.gsã®æ§‹é€ ã«ä¾å­˜)
        const statusKey = Object.keys(CONFIG.STATUS).find(key => CONFIG.STATUS[key] === app.status);
        document.getElementById("modalStatus").value = statusKey || 'IN_PROGRESS';
    }

    modal.showModal();
  };

  window.closeModal = function() {
    document.getElementById("statusModal").close();
  };

  window.handleStatusUpdate = function(event) {
    event.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€ä¿¡ã‚’é˜²æ­¢
    
    if (!currentApplicationId) return;

    const newStatusKey = document.getElementById("modalStatus").value;

    google.script.run
      .withSuccessHandler(res => {
        if (res.success) {
          alert(`ç”³è«‹ID ${currentApplicationId} ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`);
          loadApplications(); // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
        } else {
          alert(`çŠ¶æ…‹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${res.error}`);
        }
        closeModal();
      })
      .withFailureHandler(err => {
        console.error("çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
        alert("çŠ¶æ…‹æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        closeModal();
      })
      .updateApplicationStatus(currentApplicationId, newStatusKey);
  };

});

// CONFIGã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯GASå´ã‹ã‚‰includeã•ã‚Œã¦ã„ã‚‹å‰æ
// ãŸã ã—ã€ã“ã®clientå´ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§CONFIGã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€backend.gsã®doGetã§
// CONFIGã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã™ã‚‹ã‹ã€åˆ¥ã®é–¢æ•°ã§å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
// ä»Šå›ã¯ã€backend.gsã§CONFIGãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å‰æã§å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™ã€‚
</script>
